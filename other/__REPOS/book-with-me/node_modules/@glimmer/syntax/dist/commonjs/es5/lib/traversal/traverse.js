'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.default = traverse;
exports.normalizeVisitor = normalizeVisitor;

var _visitorKeys = require('../types/visitor-keys');

var _visitorKeys2 = _interopRequireDefault(_visitorKeys);

var _errors = require('./errors');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function visitNode(visitor, node) {
    var handler = visitor[node.type] || visitor.All || null;
    var result = void 0;
    if (handler && handler['enter']) {
        result = handler['enter'].call(null, node);
    }
    if (result !== undefined && result !== null) {
        if (JSON.stringify(node) === JSON.stringify(result)) {
            result = undefined;
        } else if (Array.isArray(result)) {
            return visitArray(visitor, result) || result;
        } else {
            return visitNode(visitor, result) || result;
        }
    }
    if (result === undefined) {
        var keys = _visitorKeys2.default[node.type];
        for (var i = 0; i < keys.length; i++) {
            visitKey(visitor, handler, node, keys[i]);
        }
        if (handler && handler['exit']) {
            result = handler['exit'].call(null, node);
        }
    }
    return result;
}
function visitKey(visitor, handler, node, key) {
    var value = node[key];
    if (!value) {
        return;
    }
    var keyHandler = handler && (handler.keys[key] || handler.keys.All);
    var result = void 0;
    if (keyHandler && keyHandler.enter) {
        result = keyHandler.enter.call(null, node, key);
        if (result !== undefined) {
            throw (0, _errors.cannotReplaceOrRemoveInKeyHandlerYet)(node, key);
        }
    }
    if (Array.isArray(value)) {
        visitArray(visitor, value);
    } else {
        var _result = visitNode(visitor, value);
        if (_result !== undefined) {
            assignKey(node, key, _result);
        }
    }
    if (keyHandler && keyHandler.exit) {
        result = keyHandler.exit.call(null, node, key);
        if (result !== undefined) {
            throw (0, _errors.cannotReplaceOrRemoveInKeyHandlerYet)(node, key);
        }
    }
}
function visitArray(visitor, array) {
    for (var i = 0; i < array.length; i++) {
        var result = visitNode(visitor, array[i]);
        if (result !== undefined) {
            i += spliceArray(array, i, result) - 1;
        }
    }
}
function assignKey(node, key, result) {
    if (result === null) {
        throw (0, _errors.cannotRemoveNode)(node[key], node, key);
    } else if (Array.isArray(result)) {
        if (result.length === 1) {
            node[key] = result[0];
        } else {
            if (result.length === 0) {
                throw (0, _errors.cannotRemoveNode)(node[key], node, key);
            } else {
                throw (0, _errors.cannotReplaceNode)(node[key], node, key);
            }
        }
    } else {
        node[key] = result;
    }
}
function spliceArray(array, index, result) {
    if (result === null) {
        array.splice(index, 1);
        return 0;
    } else if (Array.isArray(result)) {
        array.splice.apply(array, [index, 1].concat(result));
        return result.length;
    } else {
        array.splice(index, 1, result);
        return 1;
    }
}
function traverse(node, visitor) {
    visitNode(normalizeVisitor(visitor), node);
}
function normalizeVisitor(visitor) {
    var normalizedVisitor = {};
    for (var type in visitor) {
        var handler = visitor[type] || visitor.All;
        var normalizedKeys = {};
        if (typeof handler === 'object') {
            var keys = handler.keys;
            if (keys) {
                for (var key in keys) {
                    var keyHandler = keys[key];
                    if (typeof keyHandler === 'object') {
                        normalizedKeys[key] = {
                            enter: typeof keyHandler.enter === 'function' ? keyHandler.enter : null,
                            exit: typeof keyHandler.exit === 'function' ? keyHandler.exit : null
                        };
                    } else if (typeof keyHandler === 'function') {
                        normalizedKeys[key] = {
                            enter: keyHandler,
                            exit: null
                        };
                    }
                }
            }
            normalizedVisitor[type] = {
                enter: typeof handler.enter === 'function' ? handler.enter : null,
                exit: typeof handler.exit === 'function' ? handler.exit : null,
                keys: normalizedKeys
            };
        } else if (typeof handler === 'function') {
            normalizedVisitor[type] = {
                enter: handler,
                exit: null,
                keys: normalizedKeys
            };
        }
    }
    return normalizedVisitor;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhdmVyc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL3RyYXZlcnNhbC90cmF2ZXJzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLEFBQU8sQUFBVyxBQUFNLEFBQXVCLEFBQUM7Ozs7QUFDaEQsQUFBTyxBQUNMLEFBQWdCLEFBQ2hCLEFBQWlCLEFBQ2pCLEFBQW9DLEFBQ3JDLEFBQU0sQUFBVSxBQUFDOzs7O0FBd0JsQixtQkFBbUIsQUFBb0IsU0FBRSxBQUFnQixNQUN2RDtRQUFJLEFBQU8sVUFBb0MsQUFBTyxRQUFDLEFBQUksS0FBQyxBQUFJLEFBQUMsU0FBSSxBQUFPLFFBQUMsQUFBRyxPQUFJLEFBQUksQUFBQyxBQUN6RjtRQUFJLEFBQU0sQUFBQyxBQUVYLEFBQUUsQUFBQztRQUFDLEFBQU8sV0FBSSxBQUFPLFFBQUMsQUFBTyxBQUFDLEFBQUMsVUFBQyxBQUFDLEFBQ2hDLEFBQU07aUJBQUcsQUFBTyxRQUFDLEFBQU8sQUFBQyxTQUFDLEFBQUksS0FBQyxBQUFJLE1BQUUsQUFBSSxBQUFDLEFBQUMsQUFDN0MsQUFBQyxBQUVELEFBQUUsQUFBQzs7UUFBQyxBQUFNLFdBQUssQUFBUyxhQUFJLEFBQU0sV0FBSyxBQUFJLEFBQUMsTUFBQyxBQUFDLEFBQzVDLEFBQUUsQUFBQztZQUFDLEFBQUksS0FBQyxBQUFTLFVBQUMsQUFBSSxBQUFDLFVBQUssQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFNLEFBQUMsQUFBQyxTQUFDLEFBQUMsQUFDcEQsQUFBTTtxQkFBRyxBQUFTLEFBQUMsQUFDckIsQUFBQyxBQUFDLEFBQUk7bUJBQUssQUFBSyxNQUFDLEFBQU8sUUFBQyxBQUFNLEFBQUMsQUFBQyxTQUFDLEFBQUMsQUFDakMsQUFBTTttQkFBQyxBQUFVLFdBQUMsQUFBTyxTQUFFLEFBQU0sQUFBQyxXQUFJLEFBQU0sQUFBQyxBQUMvQyxBQUFD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QUFJLEFBQ25FLEFBQUk7c0JBQUcsT0FBTyxBQUFPLFFBQUMsQUFBSSxTQUFwQixBQUF5QixBQUFVLEFBQUMsYUFBRyxBQUFPLFFBQUMsQUFBSSxPQUFHLEFBQUksQUFDaEUsQUFBSTtzQkFIb0IsQUFHbEIsQUFBYyxBQUNyQixBQUFDLEFBQ0osQUFBQyxBQUFDLEFBQUksQUFKRixBQUFLOztlQUlGLEFBQUUsQUFBQyxJQUFDLE9BQU8sQUFBTyxZQUFLLEFBQVUsQUFBQyxZQUFDLEFBQUMsQUFDekMsQUFBaUI7OEJBQUMsQUFBSSxBQUFDO3VCQUNkLEFBQU8sQUFDZCxBQUFJO3NCQUFFLEFBQUksQUFDVixBQUFJO3NCQUhvQixBQUdsQixBQUFjLEFBQ3JCLEFBQUMsQUFDSixBQUFDLEFBQ0gsQUFMTSxBQUFLLEFBS1Y7O0FBRUQsQUFBTTs7V0FBQyxBQUFpQixBQUFDLEFBQzNCLEFBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdmlzaXRvcktleXMgZnJvbSAnLi4vdHlwZXMvdmlzaXRvci1rZXlzJztcbmltcG9ydCB7XG4gIGNhbm5vdFJlbW92ZU5vZGUsXG4gIGNhbm5vdFJlcGxhY2VOb2RlLFxuICBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXRcbn0gZnJvbSAnLi9lcnJvcnMnO1xuaW1wb3J0ICogYXMgbm9kZXMgZnJvbSAnLi4vdHlwZXMvbm9kZXMnO1xuaW1wb3J0IHsgT3B0aW9uIH0gZnJvbSBcIkBnbGltbWVyL2ludGVyZmFjZXNcIjtcblxuZXhwb3J0IHR5cGUgTm9kZUhhbmRsZXI8VCBleHRlbmRzIG5vZGVzLk5vZGU+ID0gTm9kZUhhbmRsZXJGdW5jdGlvbjxUPiB8IEVudGVyRXhpdE5vZGVIYW5kbGVyPFQ+O1xuXG5leHBvcnQgdHlwZSBTcGVjaWZpY05vZGVWaXNpdG9yID0ge1xuICBbUCBpbiBrZXlvZiBub2Rlcy5Ob2Rlc10/OiBOb2RlSGFuZGxlcjxub2Rlcy5Ob2Rlc1tQXT47XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIE5vZGVWaXNpdG9yIGV4dGVuZHMgU3BlY2lmaWNOb2RlVmlzaXRvciB7XG4gIEFsbD86IE5vZGVIYW5kbGVyPG5vZGVzLk5vZGU+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE5vZGVIYW5kbGVyRnVuY3Rpb248VCBleHRlbmRzIG5vZGVzLk5vZGU+IHtcbiAgKHRoaXM6IG51bGwsIG5vZGU6IFQpOiBhbnkgfCBudWxsIHwgdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVudGVyRXhpdE5vZGVIYW5kbGVyPFQgZXh0ZW5kcyBub2Rlcy5Ob2RlPiB7XG4gIGVudGVyPzogTm9kZUhhbmRsZXJGdW5jdGlvbjxUPjtcbiAgZXhpdD86IE5vZGVIYW5kbGVyRnVuY3Rpb248VD47XG4gIGtleXM/OiBhbnk7XG59XG5cbmZ1bmN0aW9uIHZpc2l0Tm9kZSh2aXNpdG9yOiBOb2RlVmlzaXRvciwgbm9kZTogbm9kZXMuTm9kZSk6IGFueSB7XG4gIGxldCBoYW5kbGVyOiBPcHRpb248Tm9kZUhhbmRsZXI8bm9kZXMuTm9kZT4+ID0gdmlzaXRvcltub2RlLnR5cGVdIHx8IHZpc2l0b3IuQWxsIHx8IG51bGw7XG4gIGxldCByZXN1bHQ7XG5cbiAgaWYgKGhhbmRsZXIgJiYgaGFuZGxlclsnZW50ZXInXSkge1xuICAgIHJlc3VsdCA9IGhhbmRsZXJbJ2VudGVyJ10uY2FsbChudWxsLCBub2RlKTtcbiAgfVxuXG4gIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCAmJiByZXN1bHQgIT09IG51bGwpIHtcbiAgICBpZiAoSlNPTi5zdHJpbmdpZnkobm9kZSkgPT09IEpTT04uc3RyaW5naWZ5KHJlc3VsdCkpIHtcbiAgICAgIHJlc3VsdCA9IHVuZGVmaW5lZDtcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgICAgcmV0dXJuIHZpc2l0QXJyYXkodmlzaXRvciwgcmVzdWx0KSB8fCByZXN1bHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB2aXNpdE5vZGUodmlzaXRvciwgcmVzdWx0KSB8fCByZXN1bHQ7XG4gICAgfVxuICB9XG5cbiAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgbGV0IGtleXMgPSB2aXNpdG9yS2V5c1tub2RlLnR5cGVdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICB2aXNpdEtleSh2aXNpdG9yLCBoYW5kbGVyIGFzIGFueSwgbm9kZSBhcyBhbnksIGtleXNbaV0pO1xuICAgIH1cblxuICAgIGlmIChoYW5kbGVyICYmIGhhbmRsZXJbJ2V4aXQnXSkge1xuICAgICAgcmVzdWx0ID0gaGFuZGxlclsnZXhpdCddLmNhbGwobnVsbCwgbm9kZSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gdmlzaXRLZXkodmlzaXRvcjogTm9kZVZpc2l0b3IsIGhhbmRsZXI6IEVudGVyRXhpdE5vZGVIYW5kbGVyPG5vZGVzLk5vZGU+LCBub2RlOiBub2Rlcy5Ob2RlICYgVHJhdmVyc2VkTm9kZSwga2V5OiBzdHJpbmcpIHtcbiAgbGV0IHZhbHVlID0gbm9kZVtrZXldO1xuICBpZiAoIXZhbHVlKSB7IHJldHVybjsgfVxuXG4gIGxldCBrZXlIYW5kbGVyID0gaGFuZGxlciAmJiAoaGFuZGxlci5rZXlzW2tleV0gfHwgaGFuZGxlci5rZXlzLkFsbCk7XG4gIGxldCByZXN1bHQ7XG5cbiAgaWYgKGtleUhhbmRsZXIgJiYga2V5SGFuZGxlci5lbnRlcikge1xuICAgIHJlc3VsdCA9IGtleUhhbmRsZXIuZW50ZXIuY2FsbChudWxsLCBub2RlLCBrZXkpO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY2Fubm90UmVwbGFjZU9yUmVtb3ZlSW5LZXlIYW5kbGVyWWV0KG5vZGUsIGtleSk7XG4gICAgfVxuICB9XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgdmlzaXRBcnJheSh2aXNpdG9yLCB2YWx1ZSk7XG4gIH0gZWxzZSB7XG4gICAgbGV0IHJlc3VsdCA9IHZpc2l0Tm9kZSh2aXNpdG9yLCB2YWx1ZSk7XG4gICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBhc3NpZ25LZXkobm9kZSwga2V5LCByZXN1bHQpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChrZXlIYW5kbGVyICYmIGtleUhhbmRsZXIuZXhpdCkge1xuICAgIHJlc3VsdCA9IGtleUhhbmRsZXIuZXhpdC5jYWxsKG51bGwsIG5vZGUsIGtleSk7XG4gICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXQobm9kZSwga2V5KTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gdmlzaXRBcnJheSh2aXNpdG9yOiBOb2RlVmlzaXRvciwgYXJyYXk6IG5vZGVzLk5vZGVbXSkge1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7XG4gICAgbGV0IHJlc3VsdCA9IHZpc2l0Tm9kZSh2aXNpdG9yLCBhcnJheVtpXSk7XG4gICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpICs9IHNwbGljZUFycmF5KGFycmF5LCBpLCByZXN1bHQpIC0gMTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBUcmF2ZXJzZWROb2RlIHtcbiAgW2tleTogc3RyaW5nXTogbm9kZXMuTm9kZTtcbn1cblxuZnVuY3Rpb24gYXNzaWduS2V5KG5vZGU6IFRyYXZlcnNlZE5vZGUgJiBub2Rlcy5Ob2RlLCBrZXk6IHN0cmluZywgcmVzdWx0OiBub2Rlcy5Ob2RlKSB7XG4gIGlmIChyZXN1bHQgPT09IG51bGwpIHtcbiAgICB0aHJvdyBjYW5ub3RSZW1vdmVOb2RlKG5vZGVba2V5XSwgbm9kZSwga2V5KTtcbiAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICBpZiAocmVzdWx0Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgbm9kZVtrZXldID0gcmVzdWx0WzBdO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAocmVzdWx0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBjYW5ub3RSZW1vdmVOb2RlKG5vZGVba2V5XSwgbm9kZSwga2V5KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VOb2RlKG5vZGVba2V5XSwgbm9kZSwga2V5KTtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbm9kZVtrZXldID0gcmVzdWx0O1xuICB9XG59XG5cbmZ1bmN0aW9uIHNwbGljZUFycmF5PFQ+KGFycmF5OiBUW10sIGluZGV4OiBudW1iZXIsIHJlc3VsdDogVFtdKSB7XG4gIGlmIChyZXN1bHQgPT09IG51bGwpIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIHJldHVybiAwO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSwgLi4ucmVzdWx0KTtcbiAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aDtcbiAgfSBlbHNlIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEsIHJlc3VsdCk7XG4gICAgcmV0dXJuIDE7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gdHJhdmVyc2Uobm9kZTogbm9kZXMuTm9kZSwgdmlzaXRvcjogTm9kZVZpc2l0b3IpIHtcbiAgdmlzaXROb2RlKG5vcm1hbGl6ZVZpc2l0b3IodmlzaXRvciksIG5vZGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbm9ybWFsaXplVmlzaXRvcih2aXNpdG9yOiBOb2RlVmlzaXRvcikge1xuICBsZXQgbm9ybWFsaXplZFZpc2l0b3IgPSB7fTtcblxuICBmb3IgKGxldCB0eXBlIGluIHZpc2l0b3IpIHtcbiAgICBsZXQgaGFuZGxlciA9IHZpc2l0b3JbdHlwZV0gfHwgdmlzaXRvci5BbGw7XG4gICAgbGV0IG5vcm1hbGl6ZWRLZXlzID0ge307XG5cbiAgICBpZiAodHlwZW9mIGhhbmRsZXIgPT09ICdvYmplY3QnKSB7XG4gICAgICBsZXQga2V5cyA9IGhhbmRsZXIua2V5cztcbiAgICAgIGlmIChrZXlzKSB7XG4gICAgICAgIGZvciAobGV0IGtleSBpbiBrZXlzKSB7XG4gICAgICAgICAgbGV0IGtleUhhbmRsZXIgPSBrZXlzW2tleV07XG4gICAgICAgICAgaWYgKHR5cGVvZiBrZXlIYW5kbGVyID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgbm9ybWFsaXplZEtleXNba2V5XSA9IHtcbiAgICAgICAgICAgICAgZW50ZXI6ICh0eXBlb2Yga2V5SGFuZGxlci5lbnRlciA9PT0gJ2Z1bmN0aW9uJykgPyBrZXlIYW5kbGVyLmVudGVyIDogbnVsbCxcbiAgICAgICAgICAgICAgZXhpdDogKHR5cGVvZiBrZXlIYW5kbGVyLmV4aXQgPT09ICdmdW5jdGlvbicpID8ga2V5SGFuZGxlci5leGl0IDogbnVsbFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBrZXlIYW5kbGVyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBub3JtYWxpemVkS2V5c1trZXldID0ge1xuICAgICAgICAgICAgICBlbnRlcjoga2V5SGFuZGxlcixcbiAgICAgICAgICAgICAgZXhpdDogbnVsbFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgbm9ybWFsaXplZFZpc2l0b3JbdHlwZV0gPSB7XG4gICAgICAgIGVudGVyOiAodHlwZW9mIGhhbmRsZXIuZW50ZXIgPT09ICdmdW5jdGlvbicpID8gaGFuZGxlci5lbnRlciA6IG51bGwsXG4gICAgICAgIGV4aXQ6ICh0eXBlb2YgaGFuZGxlci5leGl0ID09PSAnZnVuY3Rpb24nKSA/IGhhbmRsZXIuZXhpdCA6IG51bGwsXG4gICAgICAgIGtleXM6IG5vcm1hbGl6ZWRLZXlzXG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIG5vcm1hbGl6ZWRWaXNpdG9yW3R5cGVdID0ge1xuICAgICAgICBlbnRlcjogaGFuZGxlcixcbiAgICAgICAgZXhpdDogbnVsbCxcbiAgICAgICAga2V5czogbm9ybWFsaXplZEtleXNcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG5vcm1hbGl6ZWRWaXNpdG9yO1xufVxuIl19